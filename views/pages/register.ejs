<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulario de registro</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  </head>
  <body
    style="height: 100vh; width: 100vw"
    class="d-flex justify-content-center align-items-center"
  >
    <div class="w-25 shadow py-5 px-5">
      <h1 class="fw-light text-center mb-4" style="color: rgb(49, 49, 49)">
        Registro de Usuario
      </h1>
      <form
        class="d-flex flex-column justify-content-center align-items-center needs-validation"
        id="register"
        action="/auth/signup"
        method="post"
        onsubmit="process(event)"
        enctype="multipart/form-data"
        novalidate
      >
        <div class="mb-3">
          <input
            style="width: 300px"
            class="form-control"
            type="email"
            name="username"
            placeholder="Email"
            required
          />
          <div class="invalid-feedback">Por favor ingresa tu email</div>
        </div>
        <div class="mb-3">
          <input
            style="width: 300px"
            class="form-control"
            type="password"
            name="password"
            placeholder="Password"
            required
          />
          <div class="invalid-feedback">Por favor ingresa tu contraseña</div>
        </div>
        <div class="mb-3">
          <input
            style="width: 300px"
            class="form-control"
            type="text"
            name="nombre"
            placeholder="Nombre"
            required
          />
          <div class="invalid-feedback">Por favor ingresa tu nombre</div>
        </div>
        <div class="mb-3">
          <input
            style="width: 300px"
            class="form-control"
            type="text"
            name="direccion"
            placeholder="Dirección"
            required
          />
          <div class="invalid-feedback">Por favor ingresa tu dirección</div>
        </div>
        <div class="mb-3">
          <input
            style="width: 300px"
            class="form-control"
            type="text"
            name="edad"
            placeholder="Edad"
            required
          />
          <div class="invalid-feedback">Por favor ingresa tu edad</div>
        </div>
        <div class="mb-3">
          <input
            style="width: 300px"
            class="form-control"
            id="phone"
            type="tel"
            name="telefono"
            required
          />
          <div class="invalid-feedback">Por favor ingresa tu teléfono</div>
          <div
            class="alert alert-danger"
            id="invalid-phone"
            style="display: none"
          >
            Teléfono inválido
          </div>
        </div>
        <div class="mb-4">
          <input
            style="width: 300px"
            class="form-control"
            type="file"
            name="avatar"
            required
          />
          <div class="invalid-feedback">Por favor ingresa tu avatar</div>
        </div>
        <div class="mb-1">
          <input
            style="width: 300px"
            class="btn btn-success"
            type="submit"
            value="Register"
          />
        </div>
      </form>
      <hr />
      <div class="w-100 d-flex justify-content-center align-items-center">
        <a href="/auth/login" style="width: 300px" class="btn btn-success">
          Ir a login
        </a>
      </div>
    </div>
  </body>
  <script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
      "use strict";

      // Fetch all the forms we want to apply custom Bootstrap validation styles to
      var forms = document.querySelectorAll(".needs-validation");

      // Loop over them and prevent submission
      Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener(
          "submit",
          function (event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }

            form.classList.add("was-validated");
          },
          false
        );
      });
    })();
  </script>
  <script>
    /*
    function getIp(callback) {
      fetch("https://ipinfo.io/json?token=a71c54238e16a7", {
        headers: { Accept: "application/json" },
      })
        .then((resp) => resp.json())
        .catch(() => {
          return {
            country: "us",
          };
        })
        .then((resp) => callback(resp.country));
    }
    */
    const phoneInputField = document.querySelector("#phone");
    const phoneInput = window.intlTelInput(phoneInputField, {
      //initialCountry: "auto",
      //geoIpLookup: getIp,
      utilsScript:
        "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
    });
  </script>
  <script>
    const error = document.getElementById("invalid-phone");

    function process(event) {
      event.preventDefault();
      event.stopPropagation();
      const form = document.getElementById("register");

      const phoneNumber = phoneInput.getNumber();

      error.style.display = "none";

      const data = new URLSearchParams();
      data.append("phone", phoneNumber);

      fetch("https://validate-tel-input-4253.twil.io/lookup", {
        method: "POST",
        body: data,
      })
        .then((response) => response.json())
        .then((json) => {
          if (json.success && form.checkValidity()) {
            form.classList.add("was-validated");
            phoneInputField.value = phoneNumber;
            form.submit();
          } else {
            console.log(json.error);
            error.style.display = "";
          }
        })
        .catch((err) => {
          error.style.display = "";
          error.innerHTML = `Something went wrong: ${err}`;
        });
    }
  </script>
</html>
